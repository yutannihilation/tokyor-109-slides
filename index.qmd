---
title: |
  <b>gghighlight</b> ã®</br>
  ã€€ä½œè€…ã§ã™ã€‚</br>
  <span style="color: #F8F8F2;">ã™ã¹ã¦</span>ã‚’</br>
  ã€€ãŠè©±ã—ã—ã¾ã™ã€‚
author: "@yutannihilation"
format:
  revealjs:
    theme: ["default", "dracula.scss"]
highlight-style: "dracula"
execute: 
  echo: true
  warning: false
---

```{r}
#| include: false
knitr::opts_chunk$set(dev = "ragg_png")

library(ggplot2)
library(patchwork)

theme_set(theme_gray(base_size = 20))
update_geom_defaults("point", list(size = 3))

library(ggrepel)
update_geom_defaults("label_repel", list(size = 20 / .pt))

library(geomtextpath)
update_geom_defaults("textpath", list(size = 20 / .pt))
```


## ãƒ‰ãƒ¼ãƒ¢ï¼

::: columns
::: {.column width="50%"}
![](images/icon.jpg){fig-align="center"}
:::

::: {.column width="50%"}

Hiroaki Yutani

- Twitter: [@yutannihilation](https://twitter.com/yutannihilation)
- å¥½ããªè¨€èªï¼šRã€å¿æ®ºèª
- ggplot2 ã®ãƒ¡ãƒ³ãƒ†ãƒŠ
- ã€ŒRãƒ¦ãƒ¼ã‚¶ã®ãŸã‚ã® RStudioï¼»å®Ÿè·µï¼½å…¥é–€ã€ã®ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã®ç« ã‚’æ‹…å½“

:::
:::

## ã‚ã‚Œã‹ã‚‰5å¹´...

ä¼èª¬ã® Hadley Wickham ç·Šæ€¥æ¥æ—¥å›

[![](images/slide-2018.png)](https://speakerdeck.com/yutannihilation/introduction-to-gghighlight)

## ã‚ã‚Œã‹ã‚‰5å¹´...

* ãã†ã„ãˆã°æ—¥æœ¬èªã§ç™ºè¡¨ã—ãŸã“ã¨ãŒãªã‹ã£ãŸï¼
* ã‚ã¨ã€è‹±èªåŠ›ã¨æ™‚é–“ã®å•é¡Œã§ç°¡å˜ãªæ©Ÿèƒ½ç´¹ä»‹ã ã‘ã ã£ãŸã®ã§ã€ä»Šæ—¥ã¯ãƒ•ãƒ«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãŠå±Šã‘ã—ã¾ã™ï¼

## ä»Šæ—¥è©±ã™ã“ã¨

* gghighlightã®ä½¿ã„æ–¹
* gghighlightã‚’ä½¿ã‚ãšã«ã‚„ã‚‹ã¨ã©ã†ãªã‚‹ã‹

## â€»è¡¨è¨˜ã«ã¤ã„ã¦

ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã§ã¯åˆå­—ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
æ…£ã‚Œã¦ã„ãªã„ã¨èª­ã¿ã¥ã‚‰ã„ã‹ã‚‚ã§ã™ã€‚ã™ã¿ã¾ã›ã‚“ï¼

| è¡¨ç¤º | å®Ÿéš›ã®æ–‡å­— |
|------|------------|
| `<=` |  `<` `=` ï¼ˆå°ãªã‚Šã‚¤ã‚³ãƒ¼ãƒ«ï¼‰  |
| `<-` |  `<` `-` ï¼ˆä»£å…¥ï¼‰|
| `|>` |  `|` `>` ï¼ˆãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ï¼‰|

# **gghighlight**ã®ä½¿ã„æ–¹

## gghighlightã¨ã¯

* æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãŸã‚ã®Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
  * æ¡ä»¶ã¯ `dplyr::filter()` ã¨åŒã˜ãƒ«ãƒ¼ãƒ«ã§è©•ä¾¡ã•ã‚Œã‚‹^[ã¨ã„ã†ã‹ã€å†…éƒ¨ã§ã¯`dplyr::filter()`ã‚’ä½¿ã£ã¦ã„ã‚‹]
* ã‚ã®Hadleyå…¬å¼[ggplot2æœ¬ï¼ˆç¬¬ä¸‰ç‰ˆï¼‰](https://ggplot2-book.org/annotations.html#direct-labelling)^[æ¨©åˆ©é–¢ä¿‚ã®å•é¡Œãªã®ã‹ã€æ°¸é ã«æ—¥æœ¬èªç‰ˆãŒå‡ºãªã„...]ã«ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹å®šç•ªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

## ğŸ

```{r}
#| label: "plot1-orig"
#| code-fold: true
set.seed(2)
data <- purrr::map_dfr(
  letters,
  ~ data.frame(
      x = 1:400,
      y = cumsum(runif(400, -1, 1)),
      type = .,
      flag = sample(c(TRUE, FALSE), size = 400, replace = TRUE),
      stringsAsFactors = FALSE
    )
)

library(ggplot2)
library(gghighlight)

ggplot(data, aes(x, y, colour = type)) +
  geom_line()
```

## ğŸ

* è‰²ãŒå¤šã™ãã¦è¦‹åˆ†ã‘ã‚‰ã‚Œãªã„
   * è‰²ã¯6è‰²ãã‚‰ã„ãŒæœ›ã¾ã—ã„ã€ã¨ã•ã‚Œã¦ã„ã‚‹ [^six-color]
* ã§ã‚‚ã€å€¤ã®åˆ†å¸ƒã‚’ç¤ºã™ãŸã‚ã«ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã¿ãŸãã¯ãªã„

::: {.fragment}
â†’ gghighlightã®å‡ºç•ªã§ã™ï¼
:::

[^six-color]: ã‚ã¾ã‚Šæ˜ç¢ºãªæ ¹æ‹ ã¯ãªã„ã‚‰ã—ã„ã€‚å‚è€ƒï¼š [Why are six colors common in color palettes for data visualization? - PolicyViz](https://policyviz.com/2023/05/31/why-are-six-colors-common-in-color-palettes-for-data-visualization/)

## {}

```{r}
#| label: "plot1"
ggplot(data, aes(x, y, colour = type)) +
  geom_line()
```

## {}

```{r}
#| label: "plot1_hl"
#| code-line-numbers: "3"
ggplot(data, aes(x, y, colour = type)) +
  geom_line() +
  gghighlight(max(y) >= 20)
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

CRANã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```{r}
#| eval: false
install.packages("gghighlight")
```

## åŸºæœ¬çš„ãªä½¿ã„æ–¹

* é€šå¸¸ã®ggplotã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«`+`ã§è¶³ã™ã ã‘
* ã ã„ãŸã„ã®Geomã«ä½¿ãˆã‚‹
* æ¡ä»¶ã«ã¯ä»»æ„ã®è¡¨ç¾ãŒæ›¸ã‘ã‚‹
* æ¡ä»¶ã¯è¤‡æ•°æŒ‡å®šã§ãã‚‹

```{r}
#| eval: false
ggplotã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ +
  gghighlight(æ¡ä»¶1, æ¡ä»¶2, ...)
```

## æ¡ä»¶ã®ä¾‹

* `y`ã®æœ€å¤§å€¤ãŒ20ä»¥ä¸Šã®ç·šã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹

```{r}
#| eval: false
gghighlight(max(y) >= 20)
```

* `y`ã®æœ€å¤§å€¤ãŒ20ä»¥ä¸Šã€ã‹ã¤æœ€å°å€¤ãŒ0ä»¥ä¸Šã®ç·š

```{r}
#| eval: false
gghighlight(max(y) >= 20, min(y) >= 0)
```

* ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒ100ä»¥ä¸Šã®ç·š

```{r}
#| eval: false
gghighlight(n() > 100)
```

## geom_bar() ã®ä¾‹

`price`ã®å¹³å‡ãŒ4000ä»¥ä¸Šã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

```{r}
#| eval: false
ggplot(diamonds, aes(cut, fill = cut)) +
  geom_bar() +
  gghighlight(mean(price) >= 4000)
```

```{r}
#| label: "geom_bar"
#| echo: false
#| layout-ncol: 2
p1 <- ggplot(diamonds, aes(cut, fill = cut)) +
  geom_bar()
p2 <- p1 + gghighlight(mean(price) >= 4000)

p1 + ggtitle("before")
p2 + ggtitle("after")
```

## geom_point() ã®ä¾‹

`disp`ãŒ200ä»¥ä¸Šã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

```{r}
#| eval: false
mtcars$cyl <- factor(mtcars$cyl)
ggplot(mtcars, aes(wt, mpg, colour = cyl)) +
  geom_point(alpha = 0.85) +
  gghighlight(disp >= 200)
```

```{r}
#| label: "geom_point"
#| echo: false
#| layout-ncol: 2
mtcars$cyl <- factor(mtcars$cyl)
p1 <- ggplot(mtcars, aes(wt, mpg, colour = cyl)) +
  geom_point(alpha = 0.85)
p2 <- p1 + gghighlight(disp >= 200)

p1 + ggtitle("before")
p2 + ggtitle("after")
```


## geom_sf() ã®ä¾‹

`AREA`ãŒ0.20ä»¥ä¸Šã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ

```{r}
#| eval: false
ggplot(nc) +
  geom_sf(aes(fill = AREA)) +
  gghighlight(AREA >= 0.20)
```

```{r}
#| label: "geom_sf"
#| echo: false
#| layout-ncol: 2
nc <- sf::st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE)
p1 <- ggplot(nc) +
  geom_sf(aes(fill = AREA)) +
  theme(legend.position = "top", legend.key.width = unit(40, "pt"))
p2 <- p1 + gghighlight(AREA >= 0.20)

p1 + ggtitle("before")
p2 + ggtitle("after")
```

## ã©ã†ã„ã†Geomã«ä½¿ãˆã‚‹ã®ï¼Ÿ

* ã ã„ãŸã„ä½¿ãˆã‚‹ã¯ãš
* æ­£ç¢ºã«ã¯ã€ã€ŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã¯å¿…ãšåŒã˜å›³å½¢ãŒæã‹ã‚Œã‚‹ã€ãªã‚‰ä½¿ãˆã‚‹
  * æ—¢çŸ¥ã®ãƒ€ãƒ¡ãªä¾‹ã¯`position_dodge()`

## geom_boxplot() ã®ä¾‹

ã²ã¨ã¤ã®boxplotã®å¹…ã¯ã€ãã®ç›®ç››ã‚Šã§æ¨ªä¸¦ã³ã«ãªã‚‹ã¹ãã‚«ãƒ†ã‚´ãƒªã®æ•°ã§æ±ºã¾ã‚‹ã€‚
çµã‚Šè¾¼ã¾ã‚Œã¦ã‚«ãƒ†ã‚´ãƒªæ•°ãŒå¤‰ã‚ã‚‹ã¨ã€å¹…ãŒé•ã£ã¦ã†ã¾ãé‡ãªã‚‰ãªã„ã€‚

```{r}
#| label: "geom_boxplot"
#| output-location: slide
mpg$cyl <- factor(mpg$cyl)
ggplot(mpg, aes(class, hwy, colour = cyl)) +
  geom_boxplot(alpha = 0.3) +
  gghighlight(
    max(hwy) > 40,
    unhighlighted_params = list(
      colour = "grey40"
    )
  )
```

## æ¡ä»¶ã®ç¨®é¡

* `geom_point()`ã‚„`geom_sf()`ãªã©ã€1ã¤ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒ1ã¤ã®å›³å½¢ã‚’æãGeom

::: {.fragment}
â†’ ãƒ¬ã‚³ãƒ¼ãƒ‰ã”ã¨ã«è¨ˆç®—ã•ã‚Œã‚‹æ¡ä»¶ï¼ˆä¾‹ï¼š`disp >= 200`ã€`AREA >= 0.20`ï¼‰
:::

* `geom_line()`ã‚„`geom_bar()`ãªã©ã€è¤‡æ•°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰1ã¤ã®å›³å½¢ã‚’æãGeom

::: {.fragment}
â†’ ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¨ˆç®—ã•ã‚Œã‚‹æ¡ä»¶ï¼ˆä¾‹ï¼š`mean(price) >= 4000`ã€`n() > 100`ï¼‰
:::

## æ¡ä»¶ã®ç¨®é¡

* ãˆã£ã€é›£ã—ãã¦ã©ã£ã¡ã‚’é¸ã¹ã°ã„ã„ã‹ã‚ã‹ã‚‰ãªã„...><

â†’ `gghighlight()`ã¯è‡ªå‹•ã§ã©ã£ã¡ã®è¨ˆç®—ã‚‚è©¦ã—ã¦ã€ã†ã¾ãã„ã£ãŸæ–¹ã‚’æ¡ç”¨ã™ã‚‹ã®ã§ã€é›°å›²æ°—ã§ä½¿ã£ã¦å¤§ä¸ˆå¤«ï¼

## use_group_by

* è‡ªå‹•ã§è¨ˆç®—ã—ã¦ãã‚Œã‚‹ã®ã¯ã‚ã‚ŠãŒãŸã„ã‚“ã§ã™ãŒã€ã“ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã†ã–ã„ã‚“ã§ã™ã‘ã©

```{r}
#> Warning message:
#> Tried to calculate with group_by(), but the calculation failed.
#> Falling back to ungrouped filter operation... 
```

â†’ `use_group_by`ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã—ã‚ˆã†

```{r}
#| eval: false
  gghighlight(disp >= 200,
    use_group_by = FALSE
  )
```


## TRUE / FALSE ãŒã™ã¹ã¦ã§ã¯ãªã„

ã“ã“ã¾ã§ã€ã‚ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«ã€Œæ¡ä»¶ã€ã¨æ›¸ã„ã¦ããŸãŒã€å®Ÿã¯`TRUE`/`FALSE`ã§ãªãã¦ã‚‚ã„ã„

* çµæœãŒæ•°å­—ã‚„æ–‡å­—åˆ—ã®å ´åˆã¯ã€ãã®å€¤ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦ã¹æ›¿ãˆã¦ä¸Šä½ã®ãƒ¬ã‚³ãƒ¼ãƒ‰/ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
* ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹æ•°ã¯ã€`max_highlight`ã§å¤‰ãˆã‚‰ã‚Œã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯5ï¼‰

```{r}
#| label: "non-logical-predicates"
#| output-location: slide
#| code-line-numbers: "4"
mtcars$cyl <- factor(mtcars$cyl)
ggplot(mtcars, aes(wt, mpg, colour = cyl)) +
  geom_point() +
  gghighlight(disp, max_highlight = 3)
```

# çµæœã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

## ãƒã‚¤ãƒ³ãƒˆ

1. `gghighlight()`ã®çµæœã¯é€šå¸¸ã®ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€å¥½ããªã‚ˆã†ã«ã„ã˜ã‚Œã‚‹
2. ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ã•ã‚Œæ–¹ã‚’å¤‰ãˆã‚‹ã«ã¯ã€`unhighlighted_params`
3. `gghighlight()`ã®å¯¾è±¡ã‹ã‚‰å¤–ã—ãŸã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€`gghighlight()`ã®å¾Œã«é‡ã­ã‚‹

## ä½™è«‡ï¼šå€‹äººçš„ã«æ€ã£ã¦ã‚‹ã“ã¨

* gghighlightã®ãƒ¡ã‚¤ãƒ³ã®ç›®çš„ã¯**ãƒ‡ãƒ¼ã‚¿ã®æ¢ç´¢**
* gghighlightã¯ãŸã ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ã€gghighlightã§ã§ãã‚‹ã“ã¨ã¯gghighlightã‚’ä½¿ã‚ãªãã¦ã‚‚ã§ãã‚‹

â†’ è¤‡é›‘ãªå›³ã‚’ã¤ãã‚ŠãŸã„ã®ã§ã‚ã‚Œã°ã€gghighlightã‚’ä½¿ã‚ãªã„ã§ã‚„ã£ãŸæ–¹ãŒã„ã„ã‹ã‚‚...

## gghighlight() ã®çµæœã¯ ggplot

`+`ã§ãƒ†ãƒ¼ãƒã‚’å¤‰ãˆãŸã‚Šã€patchworkã—ãŸã‚Šã§ãã‚‹ã€‚

```{r}
#| include: false

# tweak
theme_minimal <- function(...) ggplot2::theme_minimal(..., base_size = 20)
```


```{r}
#| label: "change-theme"
#| output-location: slide
p1 <- ggplot(data, aes(x, y, colour = type)) +
  geom_line()

p2 <- p1 + gghighlight(max(y) > 19) +
  theme_minimal() +
  ggtitle("å¤‰ã‚ã‚Šæœã¦ãŸå§¿")

patchwork::wrap_plots(p1, p2)
```

## facet ãŒä¾¿åˆ©

ã‚°ãƒ¬ãƒ¼ã«ãªã£ãŸéƒ¨åˆ†ã¯å…¨facetã«è¡¨ç¤ºã•ã‚Œã‚‹

```{r}
#| label: "change-facet"
p2 + facet_wrap(vars(type))
```

## facet ãŒä¾¿åˆ©

ãªã‚“ãªã‚‰ã€ã“ã®ãŸã‚ã ã‘ã«ç©ºã®`gghighlight()`ã‚’ä½¿ã†ã¾ã§ã‚ã‚‹

```{r}
#| label: "change-facet-asis"
#| output-location: slide
#| code-line-numbers: "4"
mtcars$cyl <- factor(mtcars$cyl)
ggplot(mpg, aes(displ, hwy, colour = cyl)) +
  geom_point() + 
  gghighlight() + 
  facet_wrap(vars(cyl))
```

## unhighlighted_params

ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆéƒ¨åˆ†ã®ä»»æ„ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã§ãã‚‹

1. å…ƒã®`linewidth`ã¯å¤ªç›®ã«
2. ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆéƒ¨åˆ†ã®`linewidth`ã¯ç´°ç›®ã§ä¸Šæ›¸ãã™ã‚‹

```{r}
#| label: "params"
#| code-line-numbers: "|2|4-6"
#| output-location: slide
ggplot(data, aes(x, y, colour = type)) +
  geom_line(linewidth = 3, alpha = 0.7) +
  gghighlight(max(y) > 19,
    unhighlighted_params = list(
      linewidth = 1
    )
  )
```



## unhighlighted_params

`NULL`ã‚’æŒ‡å®šã—ã¦ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆã‚’å–ã‚Šæ¶ˆã™ã“ã¨ã‚‚ã§ãã‚‹

```{r}
#| label: "params-null"
#| output-location: slide
ggplot(data, aes(x, y, colour = type)) +
  geom_line(linewidth = 1.3) +
  gghighlight(max(y) > 19,
    unhighlighted_params = list(
      colour = NULL, # <1>
      alpha = 0.2    # <2>
    ),
    keep_scales = TRUE # <3>
  )
```


1. è‰²ã¯å…ƒã®ã¾ã¾ã«ã™ã‚‹
2. ãŸã ã—é€æ˜åº¦ã‚’ä¸Šã’ã‚‹
3. ï¼ˆæ¬¡ã«èª¬æ˜ï¼‰

## keep_scales

`gghighlight()`ã¯ã€çµã‚Šè¾¼ã‚“ã å¾Œã®ãƒ‡ãƒ¼ã‚¿ã«è‰²ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã®ã§ã€å…ƒã®ãƒ—ãƒ­ãƒƒãƒˆã®è‰²ã¨ã¯ä¸€è‡´ã—ãªã„ã€‚
`keep_scales=TRUE`ã‚’æŒ‡å®šã™ã‚Œã°ã€å…ƒã®è‰²ã¨åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```{r}
mtcars$cyl <- factor(mtcars$cyl)
A <- ggplot(mtcars, aes(wt, mpg, colour = cyl)) +
  geom_point()

B <- A + gghighlight(disp)

C <- A +
  gghighlight(disp, keep_scales = TRUE)
```
## keep_scales

```{r}
#| label: "keep_scales"
#| fig-cap: "A: ã‚ªãƒªã‚¸ãƒŠãƒ«ã€B: é€šå¸¸ã€C: `keep_scales=TRUE`"
#| echo: false
wrap_plots(A, B, C) + plot_annotation(tag_levels = "A")
```

## gghighlight() ã¯é †åºãŒé‡è¦

`gghighlight()`ã¯é€šå¸¸ã®ggplotã®é–¢æ•°ã¨åŒã˜ã`+`ã§è¶³ã›ã‚‹ãŒã€**ä¸­èº«ã¯ãœã‚“ãœã‚“é•ã†**

* ggplotã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã€ãã®ãƒ—ãƒ­ãƒƒãƒˆã‚’è¡¨ç¤ºã™ã‚‹ç›´å‰ã«è©•ä¾¡ã•ã‚Œã‚‹ãŒã€`gghighlight()`ã¯`+`ã•ã‚ŒãŸæ™‚ç‚¹ã§å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹
* ãªã®ã§ã€`gghighlight()`ã‚ˆã‚Šå¾Œã«`+`ã•ã‚ŒãŸãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¯¾ã—ã¦ã¯`gghighlight()`ã®åŠ›ã¯åŠã°ãªã„
* ãŸã ã—ã€ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯æ¡ä»¶ã‚’æº€ãŸã™ã‚‚ã®ã®ã¿ã«çµã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã™ã‚‹ã«ã¯`data`å¼•æ•°ã«å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹

## gghighlight() ã¯é †åºãŒé‡è¦


```{r}
#| label: "order-of-gghighlight"
#| output-location: slide
#| code-line-numbers: "|10|8-9|11"
data2 <- tibble::tibble(
  x = rep(1:3, each = 3),
  type = rep(1:3, times = 3),
  y = x * type
)
data2$type <- factor(data2$type)

ggplot(data2, aes(x, y, colour = type)) +
  geom_line() +
  gghighlight(max(y) >= 9) +
  geom_point(data = data2)
```

::: {.fragment}

â†’ `geom_point()`ã¯ã‚«ãƒ©ãƒ•ãƒ«ãªã¾ã¾

:::



## ãƒ©ãƒ™ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå°ãƒã‚¿é›†

* gghighlightã¯ã€ãªã‚‹ã¹ãå‡¡ä¾‹ã®ä»£ã‚ã‚Šã«ç›´æ¥ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŒã€`use_direct_label=FALSE`ã«ã™ã‚‹ã¨å¸¸ã«å‡¡ä¾‹ã‚’è¡¨ç¤ºã™ã‚‹
* ãƒ©ãƒ™ãƒ«ã¯`label_params`ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹
* `geom_line()`ã¸ã®ãƒ©ãƒ™ãƒ«ã®ã¤ã‘æ–¹ã¯`line_label_type`ã§å¤‰ãˆã‚‰ã‚Œã‚‹

## "ggrepel_label"ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

ggrepelãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†

```{r}
#| label: "ggrepel_label"
#| code-line-numbers: "4"
#| output-location: slide
ggplot(data, aes(x, y, colour = type)) +
  geom_line() +
  gghighlight(max(y) >= 20,
    line_label_type = "ggrepel_label"
  )
```

## "sec_axis"

secondary axisã‚’ãŠã—ã‚ƒã‚Œã«ä½¿ã†

* æ¬ ç‚¹ï¼šå€¤ãŒè¿‘ã„ã¨ã“ã‚ã«ã‚ã‚‹ã¨ã€é‡ãªã£ã¦ã—ã¾ã£ã¦èª­ã¿ã¥ã‚‰ã„

```{r}
#| label: "sec_axis"
#| code-line-numbers: "4"
#| output-location: slide
ggplot(data, aes(x, y, colour = type)) +
  geom_line() +
  gghighlight(max(y) >= 20,
    line_label_type = "sec_axis"
  )
```

## "text_path"

geomtextpathãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã†

* æ¬ ç‚¹ï¼šç·šãŒæ›²ãŒã‚Šãã­ã£ãŸã‚Šé‡ãªã£ãŸã‚Šã™ã‚‹ã¨èª­ã¿ã¥ã‚‰ã„

```{r}
#| label: "text_path"
#| code-line-numbers: "4"
#| output-location: slide
ggplot(data, aes(x, y, colour = type)) +
  geom_line() +
  gghighlight(max(y) >= 20,
    line_label_type = "text_path"
  )
```

# **gghighlight**ã‚’æ”¯ãˆã‚‹æŠ€è¡“

ï¼ˆã“ã“ã‹ã‚‰ã¯ãƒãƒ‹ã‚¢å‘ã‘ãªã®ã§æ°—è»½ã«èã„ã¦ãã ã•ã„ï¼‰

## gghighlight ã‚’ä½¿ã‚ãšã«ã‚„ã£ã¦ã¿ã‚‹

ã¾ãšã€æ¡ä»¶ã‚’æº€ãŸã•ãªã„å€¤ã‚’`NA`ã§ç½®ãæ›ãˆã‚‹ã€‚

```{r}
library(dplyr)

data_tweak <- data |>
  mutate(
    flag = max(y) >= 20,
    bleached = if_else(flag, type, NA),
    .by = type #<1>
  )
```
1. `type`ã”ã¨ã«é›†è¨ˆ

## gghighlight ã‚’ä½¿ã‚ãšã«ã‚„ã£ã¦ã¿ã‚‹

`NA`ã«ã‚°ãƒ¬ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚

```{r}
#| label: "no-gghighlight1"
#| output-location: slide
ggplot(data_tweak) +
  aes(x, y, colour = bleached, group = type) + #<1>
  geom_line() +
  scale_colour_discrete(
    na.value = alpha("grey", 0.7) #<2>
  )
```
1. `colour=bleached`ã ã‘ã ã¨`NA`ã§1æœ¬ã®ç·šã«ãªã£ã¦ã—ã¾ã†ã€‚`group`ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã€‚
2. `NA`ã®å€¤ã¯`na.value`ã§æŒ‡å®šã§ãã‚‹ã€‚

## gghighlight ã‚’ä½¿ã‚ãšã«ã‚„ã£ã¦ã¿ã‚‹

ã“ã®ã‚¿ã‚¤ãƒ—ã®æ–¹æ³•ï¼ˆè‰²ã®å¡—ã‚Šåˆ†ã‘ã§å¯¾å¿œï¼‰ã¯ã€ã‚ã‹ã‚Šã‚„ã™ã„ãŒã€facetã§ããªã„ã¨ã„ã†æ¬ ç‚¹ãŒã‚ã‚‹ã€‚

```{r}
#| label: "no-gghighlight-facet"
last_plot() +
  facet_wrap(vars(bleached))
```

## facet ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

`facet_*()`ã¯ã€å¼•æ•°ã«æŒ‡å®šã—ãŸåå‰ã®åˆ—ãŒå«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã¯åˆ†å‰²ã™ã‚‹ãŒã€å«ã¾ã‚Œãªã„ãƒ‡ãƒ¼ã‚¿ã¯å…¨facetã«æãã€‚
ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€åˆ†å‰²ã•ã‚Œãªã„ã‚ˆã†ã«åˆ—åã‚’å¤‰ãˆãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã¤ãã‚‹ã€‚

```{r}
bleached <- data |>
  rename(TYPE = type)
```

ã¾ãŸã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«çµã£ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ã¤ãã‚‹ã€‚

```{r}
colourful <- data |>
  filter(max(y) >= 20, .by = type)
```

## facet ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ã“ã®2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ¥ã€…ã®`geom_line()`ã¨ã—ã¦é‡ã­åˆã‚ã›ã‚‹ã€‚

```{r}
#| label: "no-gghighlight2"
#| output-location: slide
ggplot(NULL, aes(x, y)) +
  geom_line(
    mapping = aes(group = TYPE),
    data = bleached,
    colour = alpha("grey", 0.7)
  ) +
  geom_line(
    mapping = aes(colour = type),
    data = colourful
  )
```

## facet ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹

ä»Šåº¦ã¯ã†ã¾ãfacetã§ãã¦ã„ã‚‹ã€‚

```{r}
#| label: "no-gghighlight2-facet"
last_plot() +
  facet_wrap(vars(type))
```

## åˆ¥è§£

ã‚ã¾ã‚ŠçŸ¥ã‚‰ã‚Œã¦ã„ãªã„ãŒã€`geom_*()`ã®`data`å¼•æ•°ã«ã¯é–¢æ•°ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚
ãã®å ´åˆã€`ggplot()`ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«ãã®é–¢æ•°ã‚’é©ç”¨ã—ãŸçµæœãŒä½¿ã‚ã‚Œã‚‹ã€‚

ãªã®ã§ã€ä¾‹ãˆã°ã€ã“ã†ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã‚€é–¢æ•°ã‚’ä½œã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¦ãŠã„ã¦ã€

```{r}
build_filter <- function(...) {
  function(data) {
    data |> filter(..., .by = type)
  }
}
```

## åˆ¥è§£

ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹æ–¹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®`data`å¼•æ•°ã«æŒ‡å®šã—ã¦ã‚‚ã„ã„ã€‚

```{r}
#| label: "no-gghighlight3"
#| output-location: slide
#| code-line-numbers: "9"
ggplot(data, aes(x, y)) +
  geom_line(
    mapping = aes(group = TYPE),
    data = bleached,
    colour = alpha("grey", 0.7)
  ) +
  geom_line(
    mapping = aes(colour = type),
    data = build_filter(max(y) >= 20)
  )
```
## åˆ¥è§£ {auto-animate="true"}

ã“ã†ã—ã¦ãŠãã¨ã€ã¡ã‚‡ã£ã¨æ¡ä»¶ã‚’å¤‰ãˆãŸããªã£ã¦ã‚‚ã“ã“ã ã‘æ›¸ãæ›ãˆã‚Œã°ã‚ˆãã¦ä¾¿åˆ©

```{r}
#| eval: false
#| code-line-numbers: "9"
ggplot(data, aes(x, y)) +
  geom_line(
    mapping = aes(group = TYPE),
    data = bleached,
    colour = alpha("grey", 0.7)
  ) +
  geom_line(
    mapping = aes(colour = type),
    data = build_filter(max(y) >= 20)
  )
```

## åˆ¥è§£ {auto-animate="true"}

ã“ã†ã—ã¦ãŠãã¨ã€ã¡ã‚‡ã£ã¨æ¡ä»¶ã‚’å¤‰ãˆãŸããªã£ã¦ã‚‚ã“ã“ã ã‘æ›¸ãæ›ãˆã‚Œã°ã‚ˆãã¦ä¾¿åˆ©

```{r}
#| eval: false
#| code-line-numbers: "9"
ggplot(data, aes(x, y)) +
  geom_line(
    mapping = aes(group = TYPE),
    data = bleached,
    colour = alpha("grey", 0.7)
  ) +
  geom_line(
    mapping = aes(colour = type),
    data = build_filter(max(y) >= 19)
  )
```

## åˆ¥è§£ {auto-animate="true"}

ã“ã†ã—ã¦ãŠãã¨ã€ã¡ã‚‡ã£ã¨æ¡ä»¶ã‚’å¤‰ãˆãŸããªã£ã¦ã‚‚ã“ã“ã ã‘æ›¸ãæ›ãˆã‚Œã°ã‚ˆãã¦ä¾¿åˆ©

```{r}
#| eval: false
#| code-line-numbers: "9"
ggplot(data, aes(x, y)) +
  geom_line(
    mapping = aes(group = TYPE),
    data = bleached,
    colour = alpha("grey", 0.7)
  ) +
  geom_line(
    mapping = aes(colour = type),
    data = build_filter(max(y) <= 100)
  )
```

## åˆ¥è§£

ï¼ˆã¾ã€ã“ã†ã„ã†åå¾©ã‚’æ‰‹æ—©ãã‚„ã‚ŠãŸãã¦`gghighlight()`ã‚’ã¤ãã£ãŸã‚“ã§ã™ã‘ã©ã­ï¼ï¼‰

## keep_scales

`keep_scales=TRUE`ã‚’å†ç¾ã™ã‚‹ã«ã¯ã€`expand_limits()`ã¨ã„ã†ä¾¿åˆ©ãªé–¢æ•°ãŒã‚ã‚‹ã€‚
ä»»æ„ã®aesthetic variableï¼ˆ`x`ã€`y`ã€`colour`ã€`fill`...ï¼‰ã®ã‚¹ã‚±ãƒ¼ãƒ«ã®ç¯„å›²ã‚’æ‹¡å¤§ã—ã¦ãã‚Œã‚‹ã€‚

ãƒ‡ãƒ¼ã‚¿ã«ã¯å«ã¾ã‚Œãªã„ãŒå‡¡ä¾‹ã«ã¯ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã—ãŸã„ã€ã¿ãŸã„ãªã¨ãã«ä¾¿åˆ©ã€‚

```{r}
#| label: "no-gghighlight4"
#| output-location: slide
last_plot() +
  expand_limits(
    colour = unique(data$type)
  )
```

## ggrepel ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

## geomtextpath ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸


# References

## {}

* [Plotting background data for groups with ggplot2](https://drsimonj.svbtle.com/plotting-background-data-for-groups-with-ggplot2)
* [Label line ends in time series with ggplot2](https://drsimonj.svbtle.com/label-line-ends-in-time-series-with-ggplot2)
